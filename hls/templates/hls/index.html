{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS æ–‡ä»¶æ‰«æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-hint {
            margin-top: 5px;
            font-size: 12px;
            color: #999;
        }

        .folder-selectors {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .folder-select-wrapper {
            position: relative;
        }

        .folder-select-wrapper select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        .folder-select-wrapper select:focus {
            outline: none;
            border-color: #667eea;
        }

        .folder-select-wrapper select:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .progress-bar {
            margin-top: 20px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 25px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 13px;
            }
            
            .info-box {
                padding: 12px;
            }
            
            .info-box h3 {
                font-size: 14px;
            }
            
            .info-box p {
                font-size: 13px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            label {
                font-size: 14px;
            }
            
            select, input[type="text"] {
                padding: 10px;
                font-size: 14px;
            }

            .folder-selectors {
                gap: 8px;
            }

            .folder-select-wrapper select {
                padding: 10px;
                font-size: 14px;
            }
            
            button {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 20px;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .info-box {
                padding: 10px;
            }
            
            .info-box p {
                font-size: 12px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLS æ–‡ä»¶æ‰«æç³»ç»Ÿ</h1>
        <p class="subtitle">é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¡«å†™ä¿¡æ¯ï¼Œå¼€å§‹æ‰«æ m3u8 æ–‡ä»¶</p>

        <div class="info-box">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <p>â€¢ <strong>æ–‡ä»¶å¤¹</strong>ï¼šä» Media/HLS ç›®å½•ä¸‹ä¸€çº§ä¸€çº§é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹</p>
            <p>â€¢ <strong>çº§åˆ«</strong>ï¼šæ–‡ä»¶çš„ç­‰çº§åˆ†ç±»ï¼ˆé»˜è®¤ï¼šGeneralï¼‰</p>
            <p>â€¢ <strong>ä½œè€…</strong>ï¼šæ–‡ä»¶ä¸Šä¼ çš„ä½œè€…ï¼ˆé»˜è®¤ï¼šCCAVï¼‰</p>
            <p>â€¢ <strong>ä¸“è¾‘</strong>ï¼šæ–‡ä»¶æ‰€å±çš„ä¸“è¾‘åç§°ï¼ˆå¯é€‰ï¼‰</p>
            <p>â€¢ <strong>ä¸»é¢˜</strong>ï¼šæ–‡ä»¶æ‰€å±çš„å¤§æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</p>
            <p>â€¢ æ‰«æè¿‡ç¨‹å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>

        <form id="scanForm" method="post" action="{% url 'hls:scan' %}">
            {% csrf_token %}
            
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶å¤¹</label>
                <div id="folderSelectors" class="folder-selectors">
                    <!-- çº§è”é€‰æ‹©æ¡†å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
                <input type="hidden" id="folder" name="folder" required>
                <div class="input-hint">ä» Media/HLS ç›®å½•ä¸‹ä¸€çº§ä¸€çº§é€‰æ‹©æ–‡ä»¶å¤¹</div>
            </div>

            <div class="form-group">
                <label for="level">çº§åˆ«</label>
                <div class="input-wrapper">
                    <input type="text" id="level" name="level" value="General" maxlength="16" required>
                </div>
                <div class="input-hint">æ–‡ä»¶çš„ç­‰çº§åˆ†ç±»</div>
            </div>

            <div class="form-group">
                <label for="author">ä½œè€…</label>
                <div class="input-wrapper">
                    <input type="text" id="author" name="author" value="CCAV" maxlength="64">
                </div>
                <div class="input-hint">æ–‡ä»¶ä¸Šä¼ çš„ä½œè€…ï¼ˆé»˜è®¤ï¼šCCAVï¼‰</div>
            </div>

            <div class="form-group">
                <label for="album">ä¸“è¾‘</label>
                <div class="input-wrapper">
                    <input type="text" id="album" name="album" maxlength="255">
                </div>
                <div class="input-hint">æ–‡ä»¶æ‰€å±çš„ä¸“è¾‘åç§°ï¼ˆå¯é€‰ï¼‰</div>
            </div>

            <div class="form-group">
                <label for="subject">ä¸»é¢˜</label>
                <div class="input-wrapper">
                    <input type="text" id="subject" name="subject" maxlength="255">
                </div>
                <div class="input-hint">æ–‡ä»¶æ‰€å±çš„å¤§æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-primary" id="submitBtn">
                    å¼€å§‹æ‰«æ
                </button>
                <button type="reset" class="btn-secondary" id="resetBtn">
                    é‡ç½®
                </button>
            </div>
        </form>

        <div class="status-message" id="statusMessage"></div>
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        // çº§è”é€‰æ‹©ç›¸å…³å˜é‡
        let currentPath = '';
        let selectors = [];

        // åˆ›å»ºé€‰æ‹©æ¡†
        function createSelector(level, path = '') {
            const wrapper = document.createElement('div');
            wrapper.className = 'folder-select-wrapper';
            wrapper.dataset.level = level;
            wrapper.dataset.path = path;

            const select = document.createElement('select');
            select.id = `folder-select-${level}`;
            select.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            select.disabled = true;

            select.addEventListener('change', function() {
                handleFolderSelect(level, this.value);
            });

            wrapper.appendChild(select);
            return { wrapper, select };
        }

        // åŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶å¤¹
        async function loadFolders(path = '') {
            try {
                const url = '{% url "hls:get_folders" %}' + (path ? `?path=${encodeURIComponent(path)}` : '');
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('æ–‡ä»¶å¤¹æ•°æ®:', data);
                
                if (data.success) {
                    return data.folders || [];
                } else {
                    showMessage(data.message || 'åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥', 'error');
                    return [];
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                return [];
            }
        }

        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
        async function handleFolderSelect(level, folderName) {
            if (!folderName) {
                // å¦‚æœé€‰æ‹©"è¯·é€‰æ‹©..."ï¼Œæ¸…é™¤åç»­é€‰æ‹©æ¡†å’Œè·¯å¾„
                removeSelectorsAfter(level);
                
                // é‡æ–°è®¡ç®—å½“å‰è·¯å¾„ï¼ˆåŸºäºå·²é€‰æ‹©çš„é€‰æ‹©æ¡†ï¼‰
                currentPath = '';
                for (let i = 0; i < level; i++) {
                    const selector = selectors.find(s => s.level === i);
                    if (selector && selector.select.value) {
                        if (currentPath) {
                            currentPath += '/' + selector.select.value;
                        } else {
                            currentPath = selector.select.value;
                        }
                    }
                }
                
                document.getElementById('folder').value = currentPath;
                updateFolderPath();
                return;
            }

            // æ„å»ºæ–°è·¯å¾„ï¼ˆåŸºäºä¹‹å‰çš„é€‰æ‹©ï¼‰
            let basePath = '';
            for (let i = 0; i < level; i++) {
                const selector = selectors.find(s => s.level === i);
                if (selector && selector.select.value) {
                    if (basePath) {
                        basePath += '/' + selector.select.value;
                    } else {
                        basePath = selector.select.value;
                    }
                }
            }
            
            const newPath = basePath ? `${basePath}/${folderName}` : folderName;
            currentPath = newPath;

            // æ›´æ–°éšè—å­—æ®µ
            document.getElementById('folder').value = newPath;

            // ç§»é™¤åç»­é€‰æ‹©æ¡†
            removeSelectorsAfter(level);

            // åŠ è½½ä¸‹ä¸€çº§ç›®å½•
            const folders = await loadFolders(newPath);

            if (folders.length > 0) {
                // åˆ›å»ºä¸‹ä¸€çº§é€‰æ‹©æ¡†
                const { wrapper, select } = createSelector(level + 1, newPath);
                const container = document.getElementById('folderSelectors');
                container.appendChild(wrapper);
                selectors.push({ level: level + 1, wrapper, select });

                // å¡«å……é€‰é¡¹
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.textContent = `ğŸ“ ${folder}`;
                    select.appendChild(option);
                });

                // å¯ç”¨é€‰æ‹©æ¡†
                select.disabled = false;
            }

            updateFolderPath();
        }

        // ç§»é™¤æŒ‡å®šçº§åˆ«ä¹‹åçš„æ‰€æœ‰é€‰æ‹©æ¡†
        function removeSelectorsAfter(level) {
            const container = document.getElementById('folderSelectors');
            const toRemove = selectors.filter(s => s.level > level);
            
            toRemove.forEach(s => {
                container.removeChild(s.wrapper);
            });

            selectors = selectors.filter(s => s.level <= level);
        }

        // æ›´æ–°æ–‡ä»¶å¤¹è·¯å¾„æ˜¾ç¤º
        function updateFolderPath() {
            // è·¯å¾„å·²ç»åœ¨éšè—å­—æ®µä¸­æ›´æ–°
            console.log('å½“å‰è·¯å¾„:', currentPath);
        }

        // åˆå§‹åŒ–çº§è”é€‰æ‹©
        async function initFolderSelectors() {
            const container = document.getElementById('folderSelectors');
            container.innerHTML = '';

            selectors = [];
            currentPath = '';

            // åˆ›å»ºç¬¬ä¸€çº§é€‰æ‹©æ¡†
            const { wrapper, select } = createSelector(0);
            container.appendChild(wrapper);
            selectors.push({ level: 0, wrapper, select });

            // åŠ è½½ç¬¬ä¸€çº§ç›®å½•
            const folders = await loadFolders('');
            
            if (folders.length > 0) {
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.textContent = `ğŸ“ ${folder}`;
                    select.appendChild(option);
                });
                select.disabled = false;
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æš‚æ— å¯ç”¨æ–‡ä»¶å¤¹';
                option.disabled = true;
                select.appendChild(option);
                showMessage('Media/HLS ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶å¤¹', 'info');
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
        }
        
        // éšè—æ¶ˆæ¯
        function hideMessage() {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'status-message';
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('scanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // éªŒè¯æ–‡ä»¶å¤¹æ˜¯å¦å·²é€‰æ‹©
            const folderPath = document.getElementById('folder').value;
            if (!folderPath || folderPath.trim() === '') {
                showMessage('è¯·é€‰æ‹©è¦æ‰«æçš„æ–‡ä»¶å¤¹', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            submitBtn.disabled = true;
            hideMessage();
            progressBar.classList.add('active');
            progressFill.style.width = '0%';
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    progressFill.style.width = '100%';
                    showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${data.scanned_count} ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸä¿å­˜ ${data.saved_count} ä¸ªæ–‡ä»¶ã€‚`, 'success');
                } else {
                    showMessage(data.message || 'æ‰«æå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ‰«æå¤±è´¥:', error);
                showMessage('æ‰«æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                setTimeout(() => {
                    progressBar.classList.remove('active');
                    progressFill.style.width = '0%';
                }, 2000);
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çº§è”é€‰æ‹©
        initFolderSelectors();
    </script>
</body>
</html>

