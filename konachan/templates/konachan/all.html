{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konachan æ•°æ®å±•ç¤º</title>
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="{% static 'konachan/css/base.css' %}">
    <!-- æ•°æ®å±•ç¤ºé¡µé¢æ ·å¼ -->
    <link rel="stylesheet" href="{% static 'konachan/css/all.css' %}">
</head>
<body>
    <div class="container">
        {% csrf_token %}
        <a href="{% url 'konachan:index' %}" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <h1>Konachan æ•°æ®å±•ç¤º</h1>
        <p class="subtitle">æ‰€æœ‰å·²é‡‡é›†çš„å›¾ç‰‡æ•°æ®</p>

        <div class="stats">
            <div class="stat-item">æ€»è®¡: {{ paginator.count }} æ¡è®°å½•</div>
            <div class="stat-item">æœ¬é¡µæ˜¾ç¤º: {{ images|length }} æ¡</div>
            <div class="stat-item">å½“å‰é¡µ: {{ images.number }}/{{ paginator.num_pages }}</div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ä½œè€…</th>
                        <th>MD5</th>
                        <th>æ–‡ä»¶å¤§å°</th>
                        <th>æ–‡ä»¶URL</th>
                        <th>é¢„è§ˆURL</th>
                        <th>æ ·æœ¬URL</th>
                        <th>JPEG URL</th>
                        <th>è¯„çº§</th>
                        <th>ä¸‹è½½çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    {% for image in images %}
                    <tr>
                        <td>
                            <span class="file-name" 
                                  {% if "å·²ä¸‹è½½" in image.download_status or "success" in image.download_status|lower or "å®Œæˆ" in image.download_status or "å·²" in image.download_status %}
                                  data-preview-url="{% url 'konachan:get_local_image' image.id 'preview' %}"
                                  data-sample-url="{% url 'konachan:get_local_image' image.id 'sample' %}"
                                  data-jpeg-url="{% url 'konachan:get_local_image' image.id 'jpeg' %}"
                                  {% else %}
                                  data-preview-url="{{ image.preview_url }}"
                                  data-sample-url="{{ image.sample_url }}"
                                  data-jpeg-url="{{ image.jpeg_url }}"
                                  {% endif %}
                                  title="ID: {{ image.id }}">
                                {{ image.id }}
                            </span>
                        </td>
                        <td>{{ image.author }}</td>
                        <td>{{ image.md5 }}</td>
                        <td class="file-size">{{ image.file_size|filesizeformat }}</td>
                        <td class="url-cell">
                            <a href="{{ image.file_url }}" target="_blank" class="url-link" data-full-url="{{ image.file_url }}">{{ image.file_url|truncatechars:30 }}</a>
                        </td>
                        <td class="url-cell">
                            {% if "å·²ä¸‹è½½" in image.download_status or "success" in image.download_status|lower or "å®Œæˆ" in image.download_status or "å·²" in image.download_status %}
                            <a href="{% url 'konachan:get_local_image' image.id 'preview' %}" target="_blank" class="url-link" data-full-url="{% url 'konachan:get_local_image' image.id 'preview' %}">æœ¬åœ°é¢„è§ˆ (å·²ä¸‹è½½)</a>
                            {% else %}
                            <a href="{{ image.preview_url }}" target="_blank" class="url-link" data-full-url="{{ image.preview_url }}">{{ image.preview_url|truncatechars:30 }}</a>
                            {% endif %}
                        </td>
                        <td class="url-cell">
                            {% if "å·²ä¸‹è½½" in image.download_status or "success" in image.download_status|lower or "å®Œæˆ" in image.download_status or "å·²" in image.download_status %}
                            <a href="{% url 'konachan:get_local_image' image.id 'sample' %}" target="_blank" class="url-link" data-full-url="{% url 'konachan:get_local_image' image.id 'sample' %}">æœ¬åœ°æ ·æœ¬ (å·²ä¸‹è½½)</a>
                            {% else %}
                            <a href="{{ image.sample_url }}" target="_blank" class="url-link" data-full-url="{{ image.sample_url }}">{{ image.sample_url|truncatechars:30 }}</a>
                            {% endif %}
                        </td>
                        <td class="url-cell">
                            {% if "å·²ä¸‹è½½" in image.download_status or "success" in image.download_status|lower or "å®Œæˆ" in image.download_status or "å·²" in image.download_status %}
                            <a href="{% url 'konachan:get_local_image' image.id 'jpeg' %}" target="_blank" class="url-link" data-full-url="{% url 'konachan:get_local_image' image.id 'jpeg' %}">æœ¬åœ°JPEG (å·²ä¸‹è½½)</a>
                            {% else %}
                            <a href="{{ image.jpeg_url }}" target="_blank" class="url-link" data-full-url="{{ image.jpeg_url }}">{{ image.jpeg_url|truncatechars:30 }}</a>
                            {% endif %}
                        </td>
                        <td>
                            <span class="rating-badge rating-{{ image.rating|lower }}">
                                {{ image.rating|upper }}
                            </span>
                        </td>
                        <td>
                            {% if "æœªä¸‹è½½" in image.download_status or "pending" in image.download_status|lower or "æœªå®Œæˆ" in image.download_status %}
                                <span class="download-icon" data-image-id="{{ image.id }}" title="æœªä¸‹è½½ - ç‚¹å‡»ä¸‹è½½">â¬‡ï¸</span>
                            {% elif "å·²ä¸‹è½½" in image.download_status or "success" in image.download_status|lower or "å®Œæˆ" in image.download_status or "å·²" in image.download_status %}
                                <span class="view-icon" title="å·²ä¸‹è½½ - ç‚¹å‡»æŸ¥çœ‹">ğŸ‘ï¸</span>
                            {% else %}
                                <span class="status-badge status-{{ image.download_status|lower }}">
                                    {{ image.download_status }}
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— æ•°æ®
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if paginator.num_pages > 1 %}
        <div class="pagination">
            {% if images.has_previous %}
                <a href="?page=1"><button>é¦–é¡µ</button></a>
                <a href="?page={{ images.previous_page_number }}"><button>ä¸Šä¸€é¡µ</button></a>
            {% else %}
                <button disabled>é¦–é¡µ</button>
                <button disabled>ä¸Šä¸€é¡µ</button>
            {% endif %}

            <span class="page-info">
                ç¬¬ {{ images.number }} é¡µ / å…± {{ paginator.num_pages }} é¡µ
            </span>

            {% if images.has_next %}
                <a href="?page={{ images.next_page_number }}"><button>ä¸‹ä¸€é¡µ</button></a>
                <a href="?page={{ paginator.num_pages }}"><button>æœ«é¡µ</button></a>
            {% else %}
                <button disabled>ä¸‹ä¸€é¡µ</button>
                <button disabled>æœ«é¡µ</button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆå®¹å™¨ -->
    <div class="image-preview" id="imagePreview">
        <img id="previewImage" src="" alt="é¢„è§ˆ">
    </div>

    <!-- URLé¢„è§ˆå®¹å™¨ -->
    <div class="url-preview" id="urlPreview">
        <img id="urlPreviewImage" src="" alt="é¢„è§ˆ" style="display: none;">
        <div class="url-preview-text" id="urlPreviewText" style="display: none;"></div>
    </div>

    <!-- ä¸‹è½½å®Œæˆå¼¹çª— -->
    <div class="modal-overlay" id="downloadModal" role="dialog" aria-modal="true" aria-labelledby="downloadModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h2 id="downloadModalTitle">ä¸‹è½½å®Œæˆ</h2>
            <p id="downloadModalMessage"></p>
            <button type="button" id="downloadModalClose" class="modal-close-btn">å¥½çš„</button>
        </div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="{% static 'konachan/js/common.js' %}"></script>
    <script src="{% static 'konachan/js/all.js' %}"></script>
</body>
</html>
